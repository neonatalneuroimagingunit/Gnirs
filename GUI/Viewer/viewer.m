function viewer(DataNIRS, theme)

Hmain = []; % handles to uicontrols and graphics
screenSize = get(0,'ScreenSize');
feature('DefaultCharacterSet', 'UTF8');

% Set main figure size
figureW = screenSize(3) * 3/4;   % Screen width in pixels
figureH = screenSize(4) * 3/4;   % Screen height in pixels
%figureRatio = figureW / figureH;

% Set UI objects size
%mainAxesWidth = .65;
%panelWidth = (1-mainAxesWidth) / 2;
stepW = 0.02;
stepH = 0.02;
panelaxesW = 1-2*stepW;
panelaxesH = 0.7;
npanels = 4;
panelW = (1-(npanels+1)*stepW)/npanels;
panelH = 1-panelaxesH-3*stepH;

% Set UI objects position
figurePosition = [screenSize(3)/2-figureW/2 screenSize(4)/2-figureH/2 figureW figureH];

% Set color theme
%theme = 'classic';
switch theme
    case 'classic'
        backgroundColor = get(0,'DefaultUicontrolBackgroundcolor');
        foregroundColor = 'k';
        highlightColor = [211 211 211]/255;
    case 'dark'
        backgroundColor = [68 68 68]/255;
        foregroundColor = 'w';
        highlightColor = [92 92 92]/255;
end

% Set font
if ismac
    defaultFontName = 'Lucida Grande';
    if sum(strcmp(listfonts,defaultFontName)) < 1
        defaultFontName = 'Helvetica';
    end
elseif ispc
    defaultFontName = 'Lucida Sans Unicode';
    if sum(strcmp(listfonts,defaultFontName)) < 1
        defaultFontName = 'Helvetica';
    end
else
    defaultFontName = 'Helvetica';
end

%% Main figure
Hmain.mainFigure = figure('Position', figurePosition, ...
    'Visible', 'on', ...
    'Resize', 'on',...
    'Name', 'Viewer', ...
    'Numbertitle', 'off', ...
    'Tag', 'sensors_viewer', ...
    'Color', backgroundColor, ...
    'Toolbar', 'none', ...
    'Menubar', 'none', ...
    'DoubleBuffer', 'on', ...
    'DockControls', 'off', ...
    'Renderer', 'OpenGL');


%% Menu
Hmain.menu.menuFile = uimenu('Parent', Hmain.mainFigure, 'Label', 'File');
Hmain.menu.menuFile_loadData = uimenu('Parent', Hmain.menu.menuFile, ...
    'Label', 'Load Data...', ...
    'Callback', @load_data);
Hmain.menu.menuFile_export = uimenu('Parent', Hmain.menu.menuFile, ...
    'Label', 'Export');
Hmain.menu.menuFile_export_export2png = uimenu('Parent', Hmain.menu.menuFile, ...
    'Label', 'Export to png', ...
    'Callback', @export2png);
Hmain.menu.menuFile_quit = uimenu('Parent', Hmain.menu.menuFile, ...
    'Label', 'Quit', ...
    'Callback', {@closewindow, Hmain.mainFigure});

Hmain.menu.menuEdit = uimenu('Parent', Hmain.mainFigure, 'Label', 'Edit');

Hmain.menu.menuView = uimenu('Parent', Hmain.mainFigure, 'Label', 'View');
Hmain.menu.menuView_openTable = uimenu('Parent', Hmain.menu.menuView, ...
    'Label', 'Open Table...');


%% Toolbar
Hmain.mainToolbar = uitoolbar('Parent', Hmain.mainFigure);

img1 = rand(16,16,3);
pth = uipushtool(Hmain.mainToolbar,...
    'CData', img1, 'Separator', 'on', ...
    'TooltipString', 'Your toggle tool', ...
    'HandleVisibility', 'off');

img2 = rand(16,16,3);
tth1 = uitoggletool(Hmain.mainToolbar,...
    'CData', img2, 'Separator', 'on', ...
    'TooltipString', 'Your toggle tool', ...
    'HandleVisibility', 'off');
img3 = rand(16,16,3);
tth2 = uitoggletool(Hmain.mainToolbar,...
    'CData', img3, 'Separator', 'off', ...
    'TooltipString', 'Your toggle tool', ...
    'HandleVisibility', 'off');
img4 = rand(16,16,3);
tt3 = uitoggletool(Hmain.mainToolbar,...
    'CData', img4, 'Separator', 'off', ...
    'TooltipString', 'Your toggle tool', ...
    'HandleVisibility', 'off');

%% Panels
panellabels = {'Measure', 'Subject', 'Probe', 'Selected Channel'};

labels = {...
          {'Measure ID', 'Duration', 'Samples', 'Sampling Rate', 'Type of Data'}, ...
          {'pippo', 'pluto'}, ...
          {'topolino', 'paperino', 'qui', 'quo', 'qua'}, ...
          {'archimede', 'Average', 'Average window'}, ...
         };

	 
values = {...
          {DataNIRS.MeasureID, [num2str(DataNIRS.MeasureInfo.Duration) ' s'], num2str(height(DataNIRS.Data)), [num2str(DataNIRS.MeasureInfo.AqInfo.UpdateRate) ' Hz'], 'DC'}, ...
          {'pippo', 'pluto'}, ...
          {'topolino', 'paperino', 'qui', 'quo', 'qua'}, ...
          {'archimede', '-', '-'}, ...
         }; 
	 
	 
npanels = length(panellabels);
panelwidth = (1-(npanels+1)*stepW)/npanels;

for jj = 1:1:npanels
    
    panel_position = [jj*stepW+(jj-1)*panelwidth stepH panelwidth panelH];
    Hmain.metadata(jj).panel = uipanel('parent', Hmain.mainFigure,...
        'Position', panel_position, ...
        'Units', 'normalized', ...
        'BackgroundColor', backgroundColor, ...
        'ForegroundColor', foregroundColor, ...
        'HighlightColor', highlightColor, ...
        'ShadowColor', [211 211 211]/255, ...
        'BorderType', 'line', ...
        'FontWeight', 'bold', ...
        'FontSize', 8, ...
        'FontName', defaultFontName, ...
        'Visible', 'on', ...
        'Title', panellabels{jj});
    
    currentlabels = fliplr(labels{1,jj});
	currentvalues = fliplr(values{1,jj});
	
    nlines = length(currentlabels);
    boxheight = 1/(nlines+2);
    for ii = 1:1:nlines
        Hmain.metadata(jj).label(ii) = uicontrol('Parent', Hmain.metadata(jj).panel, ...
            'Style', 'text', ...
            'BackgroundColor', backgroundColor, ...
            'ForegroundColor', foregroundColor, ...
            'Units', 'normalized', ...
            'Position', [0.1 ii*boxheight 0.3 0.1], ...
            'FontWeight', 'bold', ...
            'FontSize', 8, ...
            'FontAngle', 'italic', ...
            'HorizontalAlignment', 'left', ...
            'String', currentlabels{ii});
        Hmain.metadata(jj).value(ii) = uicontrol('Parent', Hmain.metadata(jj).panel, ...
            'Style', 'text', ...
            'BackgroundColor', backgroundColor, ...
            'ForegroundColor', foregroundColor, ...
            'Units', 'normalized', ...
            'Position', [0.4 ii*boxheight 0.6 0.1], ...
            'FontWeight', 'bold', ...
            'FontAngle', 'italic', ...
            'FontSize', 8, ...
            'String', currentvalues{ii});
    end
end


%% Tabs
Hmain.tabs.group = uitabgroup(Hmain.mainFigure, 'Position',[stepW panelH+2*stepH panelaxesW panelaxesH]);
Hmain.tabs.time = uitab('Parent', Hmain.tabs.group, ...
    'Title', 'Time', ...
    'BackgroundColor', [1 0 0], ...
    'ForegroundColor', foregroundColor);
Hmain.tabs.frequency = uitab(Hmain.tabs.group, ...
    'Title', 'Spectrum', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor);
Hmain.tabs.timefrequency = uitab(Hmain.tabs.group, ...
    'Title', 'Time-Frequency', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor);

%% Time tab
%panelaxes_position = [stepW panelH+2*stepH panelaxesW panelaxesH];
panelaxes_position = [0 0 1 1];
Hmain.timeplot.panel = uipanel('parent', Hmain.tabs.time,...
    'Position', panelaxes_position, ...
    'Units', 'normalized', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'HighlightColor', highlightColor, ...
    'ShadowColor', [211 211 211]/255, ...
    'BorderType', 'none', ...
    'FontWeight', 'bold', ...
    'FontSize', 8, ...
    'FontName', defaultFontName, ...
    'Visible', 'on');
 %   'Title', 'Time series');

Hmain.timeplot.bigaxes1 = axes('parent', Hmain.timeplot.panel,...
    'Position', [0.07 0.22 0.88 0.66], ...
    'Units', 'normalized', ...
    'Color', backgroundColor, ...
    'XColor', foregroundColor, ...
    'YColor', foregroundColor, ...
    'Xgrid', 'on', ...
    'Ygrid', 'on', ...
    'GridColor', foregroundColor, ...
    'FontWeight', 'bold', ...
    'FontSize', 8, ...
    'FontName', defaultFontName, ...
    'Visible', 'on', ...
    'Title', 'Main plots');

Hmain.timeplot.bigaxes2 = axes('parent', Hmain.timeplot.panel,...
    'Position', [0.07 0.22 0.88 0.66], ...
    'Units', 'normalized', ...
    'Color', backgroundColor, ...
    'XColor', foregroundColor, ...
    'YColor', foregroundColor, ...
    'Xgrid', 'off', ...
    'Ygrid', 'off', ...
    'XAxisLocation','top',...
    'YAxisLocation','right',...
    'GridColor', foregroundColor, ...
    'FontWeight', 'bold', ...
    'FontSize', 8, ...
    'FontName', defaultFontName, ...
    'Visible', 'on', ...
    'Title', 'Main plots');

Hmain.timeplot.smallaxes = axes('parent', Hmain.timeplot.panel,...
    'Units', 'normalized', ...
    'Position', [0.1 0.04 0.8 0.07], ...
    'Color', backgroundColor, ...
    'Color', backgroundColor, ...
    'XColor', foregroundColor, ...
    'YColor', foregroundColor, ...
    'GridColor', foregroundColor, ...
    'FontWeight', 'bold', ...
    'FontSize', 8, ...
    'FontName', defaultFontName, ...   
    'Visible', 'off', ...
    'Box', 'on', ...
    'XLimMode', 'auto', ...
    'YLimMode', 'auto', ...
    'XGrid', 'off', ...
    'YGrid', 'off');

Hmain.timeplot.spectrumaxes = axes('parent', Hmain.timeplot.panel,...
    'Position', [0.8 0.7 0.15 0.15], ...
    'Units', 'normalized', ...
    'Color', [backgroundColor 0], ...
    'XColor', foregroundColor, ...
    'YColor', foregroundColor, ...
    'Xgrid', 'off', ...
    'Ygrid', 'off', ...
    'GridColor', foregroundColor, ...
    'FontWeight', 'bold', ...
    'FontSize', 8, ...
    'FontName', defaultFontName, ...
    'Box', 'off', ...
    'Visible', 'off', ...
    'Title', 'Spectrum');


Hmain.timeplot.editmin = uicontrol('Parent', Hmain.timeplot.panel, ...
    'Style', 'edit', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.05 0.06 0.04 0.05], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@set_time_window_min, Hmain.timeplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', 'min');

Hmain.timeplot.editmax = uicontrol('Parent', Hmain.timeplot.panel, ...
    'Style', 'edit', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.91 0.06 0.04 0.05], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@set_time_window_max, Hmain.timeplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', 'max');

Hmain.timeplot.buttonBwall = uicontrol('Parent', Hmain.timeplot.panel, ...
    'Style', 'pushbutton', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.03 0.03 0.02 0.08], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@move_window, Hmain.timeplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', 'F');
Hmain.timeplot.buttonBw10 = uicontrol('Parent', Hmain.timeplot.panel, ...
    'Style', 'pushbutton', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.05 0.03 0.02 0.03], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@move_window, Hmain.timeplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', '<<');
Hmain.timeplot.buttonBw1 = uicontrol('Parent', Hmain.timeplot.panel, ...
    'Style', 'pushbutton', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.07 0.03 0.02 0.03], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@move_window, Hmain.timeplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', '<');
Hmain.timeplot.buttonFwall = uicontrol('Parent', Hmain.timeplot.panel, ...
    'Style', 'pushbutton', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.95 0.03 0.02 0.08], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@move_window, Hmain.timeplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', 'L');
Hmain.timeplot.buttonFw10 = uicontrol('Parent', Hmain.timeplot.panel, ...
    'Style', 'pushbutton', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.93 0.03 0.02 0.03], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@move_window, Hmain.timeplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', '>>');
Hmain.timeplot.buttonFw1 = uicontrol('Parent', Hmain.timeplot.panel, ...
    'Style', 'pushbutton', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.91 0.03 0.02 0.03], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@move_window, Hmain.timeplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', '>');


%% Spectrum tab
%panelaxes_position = [stepW panelH+2*stepH panelaxesW panelaxesH];
panelaxes_position = [0 0 1 1];
Hmain.spectrumplot.panel = uipanel('parent', Hmain.tabs.frequency,...
    'Position', panelaxes_position, ...
    'Units', 'normalized', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'HighlightColor', highlightColor, ...
    'ShadowColor', [211 211 211]/255, ...
    'BorderType', 'none', ...
    'FontWeight', 'bold', ...
    'FontSize', 8, ...
    'FontName', defaultFontName, ...
    'Visible', 'on');
 %   'Title', 'Time series');

Hmain.spectrumplot.bigaxes1 = axes('parent', Hmain.spectrumplot.panel,...
    'Position', [0.07 0.22 0.88 0.66], ...
    'Units', 'normalized', ...
    'Color', backgroundColor, ...
    'XColor', foregroundColor, ...
    'YColor', foregroundColor, ...
    'Xgrid', 'on', ...
    'Ygrid', 'on', ...
    'GridColor', foregroundColor, ...
    'FontWeight', 'bold', ...
    'FontSize', 8, ...
    'FontName', defaultFontName, ...
    'Visible', 'on', ...
    'Title', 'Main plots');

Hmain.spectrumplot.bigaxes2 = axes('parent', Hmain.spectrumplot.panel,...
    'Position', [0.07 0.22 0.88 0.66], ...
    'Units', 'normalized', ...
    'Color', backgroundColor, ...
    'XColor', foregroundColor, ...
    'YColor', foregroundColor, ...
    'Xgrid', 'off', ...
    'Ygrid', 'off', ...
    'XAxisLocation','top',...
    'YAxisLocation','right',...
    'GridColor', foregroundColor, ...
    'FontWeight', 'bold', ...
    'FontSize', 8, ...
    'FontName', defaultFontName, ...
    'Visible', 'off', ...
    'Title', 'Main plots');

Hmain.spectrumplot.smallaxes = axes('parent', Hmain.spectrumplot.panel,...
    'Units', 'normalized', ...
    'Position', [0.1 0.04 0.8 0.07], ...
    'Color', backgroundColor, ...
    'Color', backgroundColor, ...
    'XColor', foregroundColor, ...
    'YColor', foregroundColor, ...
    'GridColor', foregroundColor, ...
    'FontWeight', 'bold', ...
    'FontSize', 8, ...
    'FontName', defaultFontName, ...   
    'Visible', 'off', ...
    'Box', 'on', ...
    'XLimMode', 'auto', ...
    'YLimMode', 'auto', ...
    'XGrid', 'off', ...
    'YGrid', 'off');

Hmain.spectrumplot.spectrumaxes = axes('parent', Hmain.spectrumplot.panel,...
    'Position', [0.8 0.7 0.15 0.15], ...
    'Units', 'normalized', ...
    'Color', [backgroundColor 0], ...
    'XColor', foregroundColor, ...
    'YColor', foregroundColor, ...
    'Xgrid', 'off', ...
    'Ygrid', 'off', ...
    'GridColor', foregroundColor, ...
    'FontWeight', 'bold', ...
    'FontSize', 8, ...
    'FontName', defaultFontName, ...
    'Box', 'off', ...
    'Visible', 'off', ...
    'Title', 'Spectrum');


Hmain.spectrumplot.editmin = uicontrol('Parent', Hmain.spectrumplot.panel, ...
    'Style', 'edit', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.05 0.06 0.04 0.05], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@set_time_window_min, Hmain.spectrumplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', 'min');

Hmain.spectrumplot.editmax = uicontrol('Parent', Hmain.spectrumplot.panel, ...
    'Style', 'edit', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.91 0.06 0.04 0.05], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@set_time_window_max, Hmain.spectrumplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', 'max');

Hmain.spectrumplot.buttonBwall = uicontrol('Parent', Hmain.spectrumplot.panel, ...
    'Style', 'pushbutton', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.03 0.03 0.02 0.08], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@move_window, Hmain.spectrumplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', 'F');
Hmain.spectrumplot.buttonBw10 = uicontrol('Parent', Hmain.spectrumplot.panel, ...
    'Style', 'pushbutton', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.05 0.03 0.02 0.03], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@move_window, Hmain.spectrumplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', '<<');
Hmain.spectrumplot.buttonBw1 = uicontrol('Parent', Hmain.spectrumplot.panel, ...
    'Style', 'pushbutton', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.07 0.03 0.02 0.03], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@move_window, Hmain.spectrumplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', '<');
Hmain.spectrumplot.buttonFwall = uicontrol('Parent', Hmain.spectrumplot.panel, ...
    'Style', 'pushbutton', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.95 0.03 0.02 0.08], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@move_window, Hmain.spectrumplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', 'L');
Hmain.spectrumplot.buttonFw10 = uicontrol('Parent', Hmain.spectrumplot.panel, ...
    'Style', 'pushbutton', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.93 0.03 0.02 0.03], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@move_window, Hmain.spectrumplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', '>>');
Hmain.spectrumplot.buttonFw1 = uicontrol('Parent', Hmain.spectrumplot.panel, ...
    'Style', 'pushbutton', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.91 0.03 0.02 0.03], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@move_window, Hmain.spectrumplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', '>');

%% Time-frequency tab
%panelaxes_position = [stepW panelH+2*stepH panelaxesW panelaxesH];
panelaxes_position = [0 0 1 1];
Hmain.timefrequencyplot.panel = uipanel('parent', Hmain.tabs.timefrequency,...
    'Position', panelaxes_position, ...
    'Units', 'normalized', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'HighlightColor', highlightColor, ...
    'ShadowColor', [211 211 211]/255, ...
    'BorderType', 'none', ...
    'FontWeight', 'bold', ...
    'FontSize', 8, ...
    'FontName', defaultFontName, ...
    'Visible', 'on');
 %   'Title', 'Time series');

Hmain.timefrequencyplot.bigaxes1 = axes('parent', Hmain.timefrequencyplot.panel,...
    'Position', [0.07 0.22 0.88 0.66], ...
    'Units', 'normalized', ...
    'Color', backgroundColor, ...
    'XColor', foregroundColor, ...
    'YColor', foregroundColor, ...
    'Xgrid', 'on', ...
    'Ygrid', 'on', ...
    'GridColor', foregroundColor, ...
    'FontWeight', 'bold', ...
    'FontSize', 8, ...
    'FontName', defaultFontName, ...
    'Visible', 'on', ...
    'Title', 'Main plots');

Hmain.timefrequencyplot.bigaxes2 = axes('parent', Hmain.timefrequencyplot.panel,...
    'Position', [0.07 0.22 0.88 0.66], ...
    'Units', 'normalized', ...
    'Color', backgroundColor, ...
    'XColor', foregroundColor, ...
    'YColor', foregroundColor, ...
    'Xgrid', 'off', ...
    'Ygrid', 'off', ...
    'XAxisLocation','top',...
    'YAxisLocation','right',...
    'GridColor', foregroundColor, ...
    'FontWeight', 'bold', ...
    'FontSize', 8, ...
    'FontName', defaultFontName, ...
    'Visible', 'off', ...
    'Title', 'Main plots');

Hmain.timefrequencyplot.smallaxes = axes('parent', Hmain.timefrequencyplot.panel,...
    'Units', 'normalized', ...
    'Position', [0.1 0.04 0.8 0.07], ...
    'Color', backgroundColor, ...
    'Color', backgroundColor, ...
    'XColor', foregroundColor, ...
    'YColor', foregroundColor, ...
    'GridColor', foregroundColor, ...
    'FontWeight', 'bold', ...
    'FontSize', 8, ...
    'FontName', defaultFontName, ...   
    'Visible', 'off', ...
    'Box', 'on', ...
    'XLimMode', 'auto', ...
    'YLimMode', 'auto', ...
    'XGrid', 'off', ...
    'YGrid', 'off');

Hmain.timefrequencyplot.spectrumaxes = axes('parent', Hmain.timefrequencyplot.panel,...
    'Position', [0.8 0.7 0.15 0.15], ...
    'Units', 'normalized', ...
    'Color', [backgroundColor 0], ...
    'XColor', foregroundColor, ...
    'YColor', foregroundColor, ...
    'Xgrid', 'off', ...
    'Ygrid', 'off', ...
    'GridColor', foregroundColor, ...
    'FontWeight', 'bold', ...
    'FontSize', 8, ...
    'FontName', defaultFontName, ...
    'Box', 'off', ...
    'Visible', 'off', ...
    'Title', 'Spectrum');


Hmain.timefrequencyplot.editmin = uicontrol('Parent', Hmain.timefrequencyplot.panel, ...
    'Style', 'edit', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.05 0.06 0.04 0.05], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@set_time_window_min, Hmain.timefrequencyplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', 'min');

Hmain.timefrequencyplot.editmax = uicontrol('Parent', Hmain.timefrequencyplot.panel, ...
    'Style', 'edit', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.91 0.06 0.04 0.05], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@set_time_window_max, Hmain.timefrequencyplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', 'max');

Hmain.timefrequencyplot.buttonBwall = uicontrol('Parent', Hmain.timefrequencyplot.panel, ...
    'Style', 'pushbutton', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.03 0.03 0.02 0.08], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@move_window, Hmain.timefrequencyplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', 'F');
Hmain.timefrequencyplot.buttonBw10 = uicontrol('Parent', Hmain.timefrequencyplot.panel, ...
    'Style', 'pushbutton', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.05 0.03 0.02 0.03], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@move_window, Hmain.timefrequencyplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', '<<');
Hmain.timefrequencyplot.buttonBw1 = uicontrol('Parent', Hmain.timefrequencyplot.panel, ...
    'Style', 'pushbutton', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.07 0.03 0.02 0.03], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@move_window, Hmain.timefrequencyplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', '<');
Hmain.timefrequencyplot.buttonFwall = uicontrol('Parent', Hmain.timefrequencyplot.panel, ...
    'Style', 'pushbutton', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.95 0.03 0.02 0.08], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@move_window, Hmain.timefrequencyplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', 'L');
Hmain.timefrequencyplot.buttonFw10 = uicontrol('Parent', Hmain.timefrequencyplot.panel, ...
    'Style', 'pushbutton', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.93 0.03 0.02 0.03], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@move_window, Hmain.timefrequencyplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', '>>');
Hmain.timefrequencyplot.buttonFw1 = uicontrol('Parent', Hmain.timefrequencyplot.panel, ...
    'Style', 'pushbutton', ...
    'BackgroundColor', backgroundColor, ...
    'ForegroundColor', foregroundColor, ...
    'Units', 'normalized', ...
    'Position', [0.91 0.03 0.02 0.03], ...
    'FontWeight', 'bold', ...
    'FontAngle', 'italic', ...
    'Callback', {@move_window, Hmain.timefrequencyplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate}, ...
    'String', '>');

%% Plot parameters
channelNames = DataNIRS.Data.Properties.VariableNames;
columns_AC = contains(channelNames,'AC');
columns_DC = contains(channelNames,'DC');
columns_Ph = contains(channelNames,'Ph');

columns = logical(ones([length(channelNames) 1]));
columns(end) = 0;

nirsdata = table2array(DataNIRS.Data(:,columns_DC));  % channel selection from table must be smarter
nsamples = height(DataNIRS.Data);
timeline_milliseconds = DataNIRS.Data.reltime;
timeline_samples = linspace(1, nsamples, nsamples);

nchannels = size(nirsdata, 2);
channelLabels = channelNames(columns_DC);

sortingmethod = 'sortnomo';
channelColors = sorting_colors(nchannels, sortingmethod);

%% Time plot
% Main plot
axes(Hmain.timeplot.bigaxes1)
axis tight
cla;
hold on
aa = 1;
for ii = 1:1:nchannels
    Hmain.timeplot.lines1(ii) = plot(DataNIRS.Data.reltime, nirsdata(:,ii), 'LineWidth', 1, 'LineStyle', '-');
    Hmain.timeplot.lines1(ii).Color = channelColors(ii,:);
    Hmain.timeplot.lines1(ii).DisplayName = channelLabels{ii};
    aa = aa+1;
end
Hmain.timeplot.bigaxes1.YAxis.Exponent = 0;
Hmain.timeplot.lines1_selection = findall(Hmain.timeplot.lines1, 'Type', 'Line');
set(Hmain.timeplot.lines1_selection, 'buttonDownFcn', {@change_line_width, channelColors, get(Hmain.timeplot.lines1_selection(1), 'LineWidth'), 2, Hmain.timeplot, Hmain.metadata, DataNIRS.MeasureInfo.AqInfo.UpdateRate})
Hmain.timeplot.bigaxes1.XLabel.String = 'Time (s)';
Hmain.timeplot.bigaxes1.YLabel.String = 'Intensity (a.u.)';
x2 = 1:1:size(nirsdata,1);
%y2 = 1:1:size(nirsdata,1);
y2 = DataNIRS.Data.reltime/DataNIRS.MeasureInfo.AqInfo.UpdateRate;
line(x2, y2, 'Parent', Hmain.timeplot.bigaxes2, 'Color', 'none')
Hmain.timeplot.bigaxes2.XLabel.String = 'Time (samples)';
Hmain.timeplot.bigaxes2.YTickLabel = [];
Hmain.timeplot.bigaxes2.XLim = [timeline_samples(1) timeline_samples(end)];
uistack(Hmain.timeplot.spectrumaxes,'top');
% Overall plot
axes(Hmain.timeplot.smallaxes)
axis tight
cla;
hold on
for ii = 1:1:size(nirsdata,2)
    Hmain.timeplot.lines2(ii) = plot(DataNIRS.Data.reltime, nirsdata(:,ii), 'LineWidth', 1, 'LineStyle', '-');
    set(Hmain.timeplot.lines2(ii), 'Color', channelColors(ii,:));
    aa = aa+1;
end
Hmain.timeplot.editmin.String = num2str(DataNIRS.Data.reltime(1));
Hmain.timeplot.editmax.String = num2str(DataNIRS.Data.reltime(end));

rectangle_x = str2double(Hmain.timeplot.editmin.String);
rectangle_y = min(nirsdata(:));
rectangle_w = str2double(Hmain.timeplot.editmax.String)-str2double(Hmain.timeplot.editmin.String);
rectangle_h = max(nirsdata(:))-min(nirsdata(:));
Hmain.timeplot.rectangle = rectangle('Position', [rectangle_x rectangle_y rectangle_w rectangle_h], 'Curvature', [0 0], 'EdgeColor', foregroundColor);
txt_x = rectangle_w/2;
%txt_y = [1.3*max(nirsdata(:)) -10000];
txt_y = [rectangle_y+1.3*rectangle_h rectangle_y-0.3*rectangle_h];
Hmain.timeplot.txt_seconds = text(txt_x, txt_y(1), [num2str((str2double(Hmain.timeplot.editmax.String)-str2double(Hmain.timeplot.editmin.String))) ' s'], 'HorizontalAlignment', 'center', 'FontWeight', 'bold', 'FontSize', 8);
Hmain.timeplot.txt_samples = text(txt_x, txt_y(2), [num2str(round((str2double(Hmain.timeplot.editmax.String)-str2double(Hmain.timeplot.editmin.String))*DataNIRS.MeasureInfo.AqInfo.UpdateRate)) ' samples'], 'HorizontalAlignment', 'center', 'FontWeight', 'bold', 'FontSize', 8);
%Hmain.timeplot.txt = uicontrol('Style', 'text', 'Position',[str2double(Hmain.timeplot.editmin.String) min(nirsdata(:)) str2double(Hmain.timeplot.editmax.String)-str2double(Hmain.timeplot.editmin.String) max(nirsdata(:))-min(nirsdata(:))], 'String', 'Larghezza');
Hmain.timeplot.lines2_selection = findall(Hmain.timeplot.lines2, 'Type', 'Line');
set(Hmain.timeplot.lines2_selection, 'buttonDownFcn', {@move_rectangle, Hmain.timeplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate});

%% Spectrum plot
% Main plot
axes(Hmain.spectrumplot.bigaxes1)
axis tight
cla;
hold on
aa = 1;

xdata = DataNIRS.Data.reltime;
ydata = nirsdata;

% spectrum = fft(ydata);
% n = length(xdata);          % number of samples
% f = (0:n-1)*(DataNIRS.MeasureInfo.AqInfo.UpdateRate/n);         % frequency range
% power = abs(spectrum).^2/n;    % power of the DFT
% maxpower = max(power);

[power, f] = pspectrum(ydata, DataNIRS.MeasureInfo.AqInfo.UpdateRate);


for ii = 1:1:nchannels
    %temp = smooth(power(:,ii), 5);
    temp = power(:,ii);
    %temp = power(:,ii)/maxpower(ii);
    Hmain.spectrumplot.lines1(ii) = plot(f, temp, 'LineWidth', 1, 'LineStyle', '-');
    Hmain.spectrumplot.lines1(ii).Color = channelColors(ii,:);
    Hmain.spectrumplot.lines1(ii).DisplayName = channelLabels{ii};
    aa = aa+1;
end
%Hmain.spectrumplot.bigaxes1.YAxis.Exponent = 0;
Hmain.spectrumplot.lines1_selection = findall(Hmain.spectrumplot.lines1, 'Type', 'Line');
set(Hmain.spectrumplot.lines1_selection, 'buttonDownFcn', {@change_line_width, channelColors, get(Hmain.spectrumplot.lines1_selection(1), 'LineWidth'), 2, Hmain.spectrumplot, Hmain.metadata, DataNIRS.MeasureInfo.AqInfo.UpdateRate})
Hmain.spectrumplot.bigaxes1.XLabel.String = 'Frequency (Hz)';
Hmain.spectrumplot.bigaxes1.YLabel.String = 'Power (%)';
%Hmain.spectrumplot.bigaxes1.YLim = [0 0.1];
% x2 = 1:1:size(nirsdata,1);
% %y2 = 1:1:size(nirsdata,1);
% y2 = DataNIRS.Data.reltime/DataNIRS.MeasureInfo.AqInfo.UpdateRate;
% line(x2, y2, 'Parent', Hmain.spectrumplot.bigaxes2, 'Color', 'none')
% Hmain.spectrumplot.bigaxes2.XLabel.String = 'Time (samples)';
% Hmain.spectrumplot.bigaxes2.YTickLabel = [];
% Hmain.spectrumplot.bigaxes2.XLim = [timeline_samples(1) timeline_samples(end)];
uistack(Hmain.spectrumplot.spectrumaxes,'top');
% Overall plot
axes(Hmain.spectrumplot.smallaxes)
axis tight
cla;
hold on
for ii = 1:1:size(nirsdata,2)
    %temp = smooth(power(:,ii), 5);
    temp = power(:,ii);
    %temp = power(:,ii)/maxpower(ii);
    Hmain.spectrumplot.lines2(ii) = plot(f, temp, 'LineWidth', 1, 'LineStyle', '-');
    set(Hmain.spectrumplot.lines2(ii), 'Color', channelColors(ii,:));
    aa = aa+1;
end
%Hmain.spectrumplot.bigaxes2.YLim = [0 0.1];
Hmain.spectrumplot.editmin.String = num2str(f(1));
Hmain.spectrumplot.editmax.String = num2str(f(end));
Hmain.spectrumplot.rectangle = rectangle('Position', [str2double(Hmain.spectrumplot.editmin.String) min(nirsdata(:)) str2double(Hmain.spectrumplot.editmax.String)-str2double(Hmain.spectrumplot.editmin.String) max(nirsdata(:))-min(nirsdata(:))], 'Curvature', [0 0], 'EdgeColor', foregroundColor);
Hmain.spectrumplot.lines2_selection = findall(Hmain.spectrumplot.lines2, 'Type', 'Line');
set(Hmain.spectrumplot.lines2_selection, 'buttonDownFcn', {@move_rectangle, Hmain.spectrumplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate});

%% Time-Frequency plot
% Main plot
axes(Hmain.timefrequencyplot.bigaxes1)
axis tight
cla;
%hold on
%aa = 1;

%xdata = DataNIRS.Data.reltime;
ydata = nirsdata(:,1);

% spectrum = fft(ydata);
% n = length(xdata);          % number of samples
% f = (0:n-1)*(DataNIRS.MeasureInfo.AqInfo.UpdateRate/n);         % frequency range
% power = abs(spectrum).^2/n;    % power of the DFT
% maxpower = max(power);
[sp,fp,tp] = pspectrum(ydata, DataNIRS.MeasureInfo.AqInfo.UpdateRate, 'spectrogram');

surf(tp,fp,sp,sp)
view(107,30)
xlabel('Time (s)')
ylabel('Frequency (Hz)')
%rotate3d on

% for ii = 1:1:nchannels
%     %temp = smooth(power(:,ii), 5);
%     temp = power(:,ii);
%     %temp = power(:,ii)/maxpower(ii);
%     Hmain.timefrequencyplot.lines1(ii) = plot(f, temp, 'LineWidth', 1, 'LineStyle', '-');
%     Hmain.timefrequencyplot.lines1(ii).Color = channelColors(ii,:);
%     Hmain.timefrequencyplot.lines1(ii).DisplayName = channelLabels{ii};
%     aa = aa+1;
% end
%Hmain.spectrumplot.bigaxes1.YAxis.Exponent = 0;
% Hmain.timefrequencyplot.lines1_selection = findall(Hmain.timefrequencyplot.lines1, 'Type', 'Line');
% set(Hmain.timefrequencyplot.lines1_selection, 'buttonDownFcn', {@change_line_width, channelColors, get(Hmain.timefrequencyplot.lines1_selection(1), 'LineWidth'), 2, Hmain.timefrequencyplot, Hmain.metadata, DataNIRS.MeasureInfo.AqInfo.UpdateRate})
% Hmain.timefrequencyplot.bigaxes1.XLabel.String = 'Frequency (Hz)';
% Hmain.timefrequencyplot.bigaxes1.YLabel.String = 'Power (%)';
%Hmain.timefrequencyplot.bigaxes1.YLim = [0 0.1];
% x2 = 1:1:size(nirsdata,1);
% %y2 = 1:1:size(nirsdata,1);
% y2 = DataNIRS.Data.reltime/DataNIRS.MeasureInfo.AqInfo.UpdateRate;
% line(x2, y2, 'Parent', Hmain.spectrumplot.bigaxes2, 'Color', 'none')
% Hmain.timefrequencyplot.bigaxes2.XLabel.String = 'Time (samples)';
% Hmain.timefrequencyplot.bigaxes2.YTickLabel = [];
% Hmain.timefrequencyplot.bigaxes2.XLim = [timeline_samples(1) timeline_samples(end)];
% uistack(Hmain.timefrequencyplot.spectrumaxes,'top');
% % Overall plot
% axes(Hmain.timefrequencyplot.smallaxes)
% axis tight
% cla;
% hold on
% for ii = 1:1:size(nirsdata,2)
%     %temp = smooth(power(:,ii), 5);
%     temp = power(:,ii);
%     %temp = power(:,ii)/maxpower(ii);
%     Hmain.timefrequencyplot.lines2(ii) = plot(f, temp, 'LineWidth', 1, 'LineStyle', '-');
%     set(Hmain.timefrequencyplot.lines2(ii), 'Color', channelColors(ii,:));
%     aa = aa+1;
% end
% %Hmain.timefrequencyplot.bigaxes2.YLim = [0 0.1];
% Hmain.timefrequencyplot.editmin.String = num2str(f(1));
% Hmain.timefrequencyplot.editmax.String = num2str(f(end));
% Hmain.timefrequencyplot.rectangle = rectangle('Position', [str2double(Hmain.timefrequencyplot.editmin.String) min(nirsdata(:)) str2double(Hmain.timefrequencyplot.editmax.String)-str2double(Hmain.timefrequencyplot.editmin.String) max(nirsdata(:))-min(nirsdata(:))], 'Curvature', [0 0], 'EdgeColor', foregroundColor);
% Hmain.timefrequencyplot.lines2_selection = findall(Hmain.timefrequencyplot.lines2, 'Type', 'Line');
% set(Hmain.timefrequencyplot.lines2_selection, 'buttonDownFcn', {@move_rectangle, Hmain.timefrequencyplot, DataNIRS.MeasureInfo.AqInfo.UpdateRate});


%% Populate metadata

%% Turn figure on
Hmain.mainFigure.Visible = 'on';
